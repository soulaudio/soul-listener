# cargo-deny configuration — https://embarkstudios.github.io/cargo-deny/
# Run: cargo deny check

[graph]
targets = [
    { triple = "thumbv7em-none-eabihf" },
    { triple = "x86_64-unknown-linux-gnu" },
    { triple = "x86_64-pc-windows-msvc" },
]

[advisories]
# Deny known security advisories
version = 2
db-urls = ["https://github.com/rustsec/advisory-db"]
yanked = "deny"
unmaintained = "deny"
ignore = [
    # paste v1.0.15 is unmaintained (transitive via num-derive → paste).
    # No replacement available yet; low severity.
    "RUSTSEC-2024-0436",
]

[bans]
# Deny multiple versions of the same crate (except where explicitly allowed)
multiple-versions = "deny"
wildcards = "deny"          # warn on wildcard version specs (path deps are intentional in-workspace)

# Crates that must NEVER appear in the dependency graph
deny = [
    # minimp3 family: deprecated and unsound (UB on ARM shift ops).
    # Use nanomp3 (pure-Rust c2rust port with soundness fixes) instead.
    { crate = "minimp3", reason = "Deprecated and unsound — use nanomp3 instead" },
    { crate = "minimp3-rs", reason = "Deprecated and unsound — use nanomp3 instead" },
    { crate = "minimp3-sys", reason = "Deprecated and unsound — use nanomp3 instead" },
    # epd-waveshare: does not support SSD1677 — we use a custom driver
    { crate = "epd-waveshare", reason = "Does not support SSD1677/SSD2677 — custom driver in crates/firmware/src/display/driver.rs" },
    # No heap allocation — project uses heapless collections only.
    { crate = "embedded-alloc", reason = "No heap allocation in this project — use heapless instead" },
    # wee_alloc has known memory corruption (RUSTSEC-2022-0054) and is unmaintained.
    { crate = "wee_alloc", reason = "Unmaintained with known memory corruption — RUSTSEC-2022-0054" },
    # getrandom requires OS entropy sources not available on bare-metal STM32H7.
    { crate = "getrandom", reason = "Requires OS entropy — not available on thumbv7em-none-eabihf" },
]

# Skip duplicate-version checks for crates with complex dep graphs
skip = [
    # Add here if needed after running cargo deny check
]

[licenses]
# Require OSI-approved licenses
version = 2
allow = [
    "MIT",
    "Apache-2.0",
    "Apache-2.0 WITH LLVM-exception",
    "BSD-2-Clause",
    "BSD-3-Clause",
    "ISC",
    "Unicode-DFS-2016",
    "Unicode-3.0",
    "CC0-1.0",
    "Zlib",
    "MPL-2.0",
    "BSL-1.0",
]
private = { ignore = true }

[sources]
unknown-registry = "deny"
unknown-git = "deny"
allow-git = []
