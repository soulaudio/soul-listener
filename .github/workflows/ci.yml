# CI — SoulAudio DAP (Embedded Rust)
#
# Badge URL (add to README.md):
#   [![CI](https://github.com/yourusername/soulaudio-dap/actions/workflows/ci.yml/badge.svg)](https://github.com/yourusername/soulaudio-dap/actions/workflows/ci.yml)
#
# Job overview:
#   fmt            – cargo fmt check (all crates, host)
#   clippy         – cargo clippy for emulator feature set (host, std)
#   test           – cargo test per crate (host, avoids hardware/emulator conflicts)
#   check-emulator – cargo check -p firmware with emulator+debug+keyboard-input
#   check-embedded – cargo check -p firmware --target thumbv7em-none-eabihf --features hardware
#
# NOTE on feature flag exclusivity:
#   `hardware` and `emulator` are mutually exclusive. `hardware` pulls in cortex-m/
#   defmt/probe-rs dependencies that require an ARM linker and no-std. `emulator`
#   pulls in tokio and winit which require std. Never use --all-features across the
#   firmware crate — it will fail to compile on both host and embedded targets.
#
# All GitHub Actions are pinned to exact commit SHAs for supply-chain security.
# To update a pinned action:
#   1. Find the new release tag at github.com/<owner>/<repo>/releases
#   2. Get the commit SHA: git ls-remote https://github.com/<owner>/<repo> refs/tags/<tag>
#   3. Update the SHA below and the version comment
#
# Current pins (as of 2026-02-19):
#   actions/checkout          v4.2.2   11bd71901bbe5b1630ceea73d27597364c9af683
#   Swatinem/rust-cache       v2.8.2   779680da715d629ac1d338a641029a2f4372abb5
#   dtolnay/rust-toolchain    @stable  (not SHA-pinnable: action reads channel
#                                       from the git ref name; @stable is the
#                                       correct moving tag as designed by the author)

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  # Treat all warnings as errors in CI. Individual jobs may override this if
  # a particular check already passes -D warnings via its own flags.
  RUSTFLAGS: -D warnings

jobs:
  # ---------------------------------------------------------------------------
  # Format
  # ---------------------------------------------------------------------------
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: cargo fmt --all --check
        run: cargo fmt --all --check

  # ---------------------------------------------------------------------------
  # Clippy — host / emulator feature set
  #
  # We deliberately do NOT use --all-features here because `hardware` and
  # `emulator` are mutually exclusive in the firmware crate. Instead we lint
  # the workspace with the emulator feature set, which exercises all std-capable
  # code paths. The embedded code paths are covered by check-embedded below.
  #
  # firmware-ui is a cdylib. Passing --all-targets causes cargo to compile the
  # cdylib target on the host (fine), but combining `no-std` with `emulator`
  # features is contradictory, so we omit --all-features entirely.
  # ---------------------------------------------------------------------------
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2

      # eink-emulator depends on winit/softbuffer which need wayland/x11 headers
      # at compile time (pkg-config build scripts). Install them here so clippy
      # can type-check the full workspace without skipping those crates.
      - name: Install Linux GUI dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libwayland-dev \
            libxkbcommon-dev \
            libx11-dev \
            libxi-dev \
            libxrandr-dev

      # Lint all workspace crates that compile on the host (no cross-compilation).
      # Excludes the hardware-only firmware binary by using --lib instead of
      # --all-targets, which would try to compile required-features=["hardware"]
      # bins on a host target without an ARM toolchain.
      - name: cargo clippy (workspace, emulator features)
        run: |
          cargo clippy --workspace --lib --tests \
            -- -D warnings

      # Also lint firmware with the emulator feature set explicitly to catch
      # firmware-specific warnings in the emulator code paths.
      - name: cargo clippy -p firmware (emulator features)
        run: |
          cargo clippy -p firmware --lib \
            --features emulator,debug,keyboard-input \
            -- -D warnings

  # ---------------------------------------------------------------------------
  # Tests — host-native, per crate
  #
  # cargo test --workspace --all-features is unsafe here because:
  #   1. `firmware` has required-features = ["hardware"] on its binary target,
  #      which needs an ARM toolchain not available on ubuntu-latest.
  #   2. Combining hardware+emulator features links cortex-m into a std binary,
  #      causing linker errors.
  #
  # Strategy: run tests for each testable crate individually with the correct
  # feature flags. Crates that are no_std-only and have no test logic are
  # checked via check-emulator / check-embedded instead.
  # ---------------------------------------------------------------------------
  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2

      # eink-emulator is a direct test target and depends on winit/softbuffer
      # which need wayland/x11 headers to compile.
      - name: Install Linux GUI dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libwayland-dev \
            libxkbcommon-dev \
            libx11-dev \
            libxi-dev \
            libxrandr-dev

      # platform: tests use tokio + embassy-time/std (configured in dev-dependencies)
      - name: cargo test -p platform
        run: cargo test -p platform

      # eink-specs: pure data crate, no_std compatible, tests run on host
      - name: cargo test -p eink-specs
        run: cargo test -p eink-specs

      # eink-system: pure layout engine, no external dev-deps beyond tokio
      - name: cargo test -p eink-system
        run: cargo test -p eink-system

      # eink-components: pure component library, no external dev-deps beyond tokio
      - name: cargo test -p eink-components
        run: cargo test -p eink-components

      # eink-emulator: std crate, tokio-based tests
      - name: cargo test -p eink-emulator
        run: cargo test -p eink-emulator

      # eink-testing: std crate
      - name: cargo test -p eink-testing
        run: cargo test -p eink-testing

      # firmware: lib tests only (no binary — that needs hardware features + ARM)
      # The lib target has no required-features so it compiles on host.
      - name: cargo test -p firmware --lib
        run: cargo test -p firmware --lib

      # firmware-ui: rlib target, no features needed for basic compilation
      - name: cargo test -p firmware-ui
        run: cargo test -p firmware-ui

  # ---------------------------------------------------------------------------
  # Emulator Build Check
  #
  # Verifies the desktop emulator compiles with the full feature set used by
  # `cargo dev` (xtask/src/dev.rs: "emulator,debug,keyboard-input").
  # Does not run the emulator (requires a display) — just checks it compiles.
  # ---------------------------------------------------------------------------
  check-emulator:
    name: Emulator Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2

      # Install system libraries required by winit/softbuffer on Linux
      - name: Install Linux GUI dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libwayland-dev \
            libxkbcommon-dev \
            libx11-dev \
            libxi-dev \
            libxrandr-dev

      - name: cargo check -p firmware (emulator features)
        run: |
          cargo check -p firmware \
            --features emulator,debug,keyboard-input

      # Also check that the display_emulator example resolves
      - name: cargo check display_emulator example
        run: |
          cargo check -p firmware \
            --example display_emulator \
            --features emulator,debug,keyboard-input

  # ---------------------------------------------------------------------------
  # Architecture Check
  #
  # Enforces dependency boundary rules for the vertical slice architecture:
  #
  #   Layer 1 (specs/primitives):
  #     eink-specs     — pure data, no display logic, no alloc
  #
  #   Layer 2 (engine):
  #     eink-system    — layout/styling; MUST NOT depend on eink-emulator
  #     eink-components — UI components; MUST NOT depend on eink-emulator
  #
  #   Layer 3 (simulation, std only):
  #     eink-emulator  — desktop emulator; MUST NOT depend on firmware
  #
  #   HAL layer (platform crate):
  #     platform       — hardware abstractions (traits); MUST NOT depend on firmware
  #                      (platform defines traits, firmware implements them)
  #
  # Rules enforced:
  #   1. eink-system + eink-components must not require eink-emulator
  #   2. eink-specs must not depend on eink-system, eink-emulator, or eink-components
  #   3. platform must not depend on firmware (HAL must not depend on app layer)
  #   4. eink-emulator must not depend on firmware (simulator is independent of app)
  # ---------------------------------------------------------------------------
  arch:
    name: Architecture
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2

      - name: Rule 1 — eink-system and eink-components must not require eink-emulator
        run: |
          # Violation: eink-emulator appears as a dev dep OR as a required
          # (non-optional) normal dep of eink-system or eink-components.
          # Allowed: optional dep behind the `examples` feature.
          VIOLATIONS=$(cargo metadata --format-version 1 | jq -r '
            .packages[] |
            select(.name == "eink-system" or .name == "eink-components") |
            .name as $pkg |
            .dependencies[] |
            select(.name == "eink-emulator") |
            select(.kind == "dev" or (.optional == false and .kind == null)) |
            "\($pkg) has forbidden dependency on eink-emulator (kind: \(.kind // "normal"), optional: \(.optional))"
          ')
          if [ -n "$VIOLATIONS" ]; then
            echo "Architecture violations (Rule 1):"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "OK (Rule 1): eink-system and eink-components have no required dependency on eink-emulator"

      - name: Rule 2 — eink-specs must not depend on higher-layer eink crates
        run: |
          # eink-specs is a pure data crate (no_std, no display logic).
          # It must not pull in eink-system, eink-emulator, or eink-components.
          VIOLATIONS=$(cargo metadata --format-version 1 | jq -r '
            .packages[] |
            select(.name == "eink-specs") |
            .name as $pkg |
            .dependencies[] |
            select(
              .name == "eink-system" or
              .name == "eink-emulator" or
              .name == "eink-components" or
              .name == "firmware"
            ) |
            "\($pkg) must not depend on \(.name) (layer boundary violation)"
          ')
          if [ -n "$VIOLATIONS" ]; then
            echo "Architecture violations (Rule 2):"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "OK (Rule 2): eink-specs has no upward dependencies"

      - name: Rule 3 — platform (HAL) must not depend on firmware (app)
        run: |
          # The platform crate defines hardware abstraction traits.
          # Firmware implements those traits. Platform must never depend on firmware
          # (that would be a circular dependency in the HAL layer).
          VIOLATIONS=$(cargo metadata --format-version 1 | jq -r '
            .packages[] |
            select(.name == "platform") |
            .name as $pkg |
            .dependencies[] |
            select(.name == "firmware") |
            "\($pkg) must not depend on firmware (HAL must not depend on app layer)"
          ')
          if [ -n "$VIOLATIONS" ]; then
            echo "Architecture violations (Rule 3):"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "OK (Rule 3): platform crate does not depend on firmware"

      - name: Rule 4 — eink-emulator must not depend on firmware
        run: |
          # The desktop emulator simulates display hardware — it is independent
          # of the DAP application firmware. If it depended on firmware, the
          # simulator could not be used as a standalone display dev tool.
          VIOLATIONS=$(cargo metadata --format-version 1 | jq -r '
            .packages[] |
            select(.name == "eink-emulator") |
            .name as $pkg |
            .dependencies[] |
            select(.name == "firmware") |
            "\($pkg) must not depend on firmware (emulator must be firmware-agnostic)"
          ')
          if [ -n "$VIOLATIONS" ]; then
            echo "Architecture violations (Rule 4):"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "OK (Rule 4): eink-emulator does not depend on firmware"

      - name: Verify vertical slice crate dependency graph
        run: |
          # Print the complete dependency summary for audit purposes.
          # This is informational; non-zero exit if workspace metadata fails.
          echo "=== Crate dependency summary ==="
          cargo metadata --format-version 1 | jq -r '
            .packages[] |
            select(
              .name == "eink-specs" or
              .name == "eink-system" or
              .name == "eink-components" or
              .name == "eink-emulator" or
              .name == "eink-testing" or
              .name == "platform" or
              .name == "firmware" or
              .name == "firmware-ui"
            ) |
            .name + " depends on: [" +
              ([.dependencies[] | select(.kind == null) | .name] | join(", ")) +
            "]"
          ' | sort

  # ---------------------------------------------------------------------------
  # cargo-deny — License, advisory, ban, and source checks
  #
  # Runs cargo-deny against the deny.toml at the repo root.
  # Enforces:
  #   advisories — deny known security vulnerabilities (RustSec advisory DB)
  #   bans       — deny minimp3 (unsound), epd-waveshare (wrong controller)
  #   licenses   — allow-list of OSI-approved licenses only
  #   sources    — deny crates from unknown registries or git sources
  #
  # NOTE: --all-features is intentionally NOT used here because `hardware`
  # and `emulator` are mutually exclusive in the firmware crate. Instead we
  # check the default feature set which covers all workspace crates that can
  # compile on the host without cross-compilation.
  # ---------------------------------------------------------------------------
  deny:
    name: cargo-deny
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      - uses: EmbarkStudios/cargo-deny-action@v2
        with:
          command: check advisories bans licenses sources

  # ---------------------------------------------------------------------------
  # Architecture boundary enforcement via cargo tree
  #
  # Verifies that banned crates (minimp3, epd-waveshare) are not in the
  # transitive dependency graph, and enforces layering rules from CLAUDE.md.
  #
  # These checks complement the metadata-based arch job above by catching
  # issues that appear only in the resolved dependency tree (not just the
  # declared [dependencies] in Cargo.toml).
  # ---------------------------------------------------------------------------
  arch-boundaries:
    name: Architecture boundaries
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2

      - name: eink-specs must not depend on firmware
        run: |
          if cargo tree -p eink-specs 2>&1 | grep -q "firmware"; then
            echo "FAIL: eink-specs depends on firmware"
            exit 1
          fi
          echo "OK: eink-specs does not depend on firmware"

      - name: platform must not depend on firmware
        run: |
          if cargo tree -p platform 2>&1 | grep -q "^firmware\b"; then
            echo "FAIL: platform depends on firmware"
            exit 1
          fi
          echo "OK: platform does not depend on firmware"

      - name: epd-waveshare must not be in dependency graph
        run: |
          if cargo tree 2>&1 | grep -q "epd-waveshare"; then
            echo "FAIL: epd-waveshare found in dependency graph"
            exit 1
          fi
          echo "OK: epd-waveshare not present in dependency graph"

      - name: minimp3 must not be in dependency graph
        run: |
          if cargo tree 2>&1 | grep -q "minimp3"; then
            echo "FAIL: minimp3 found in dependency graph"
            exit 1
          fi
          echo "OK: minimp3 not present in dependency graph"

  # ---------------------------------------------------------------------------
  # Embedded Check (STM32H7) — fast type/borrow check without linking
  #
  # `cargo check` validates types and borrows for the ARM target without
  # running the linker. This is fast but misses linker errors (undefined
  # symbols, section overflow, flip-link layout issues). The full link is
  # performed by the build-embedded job below.
  # ---------------------------------------------------------------------------
  check-embedded:
    name: Embedded Check (STM32H7)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: thumbv7em-none-eabihf

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2

      - name: cargo check -p firmware (hardware, ARM target)
        run: |
          cargo check -p firmware \
            --target thumbv7em-none-eabihf \
            --features hardware

  # ---------------------------------------------------------------------------
  # Embedded Build (STM32H7) — full link with flip-link stack protection
  #
  # `cargo build` runs the full compilation + linker pipeline, which catches:
  #   - Undefined symbols (missing cortex-m-rt exception vectors)
  #   - Section overflow (firmware exceeds 2 MB flash limit)
  #   - flip-link layout errors (stack size + static footprint too large for RAM)
  #   - Linker script errors in memory.x
  #
  # `cargo check` (above) misses all of these because it skips the link step.
  #
  # flip-link is installed via `cargo install` because it is a standalone
  # linker binary, not a Rust library dependency. It is configured in
  # .cargo/config.toml as: linker = "flip-link" under [target.thumbv7em-none-eabihf].
  #
  # Binary size check: firmware must not exceed 2 MB (STM32H743ZI flash limit).
  # ---------------------------------------------------------------------------
  build-embedded:
    name: Embedded Build + Size Check (STM32H7)
    runs-on: ubuntu-latest
    needs: check-embedded   # Only full-build if fast check passes first
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: thumbv7em-none-eabihf

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2

      - name: Install flip-link (stack overflow protection linker)
        # flip-link is a standalone linker binary — NOT a Cargo library dep.
        # Configured in .cargo/config.toml: linker = "flip-link"
        # Ref: https://github.com/knurling-rs/flip-link
        run: cargo install flip-link

      - name: cargo build -p firmware (hardware, ARM target, release)
        # Full link: catches linker errors, section overflow, flip-link issues.
        # Uses --release to match the production build profile (LTO, opt-level=z).
        run: |
          cargo build --release \
            --target thumbv7em-none-eabihf \
            --package firmware \
            --features hardware

      - name: Check firmware binary size (must not exceed 2 MB flash)
        run: |
          ELF=target/thumbv7em-none-eabihf/release/firmware
          if [ ! -f "$ELF" ]; then
            echo "ERROR: firmware ELF not found at $ELF"
            exit 1
          fi
          SIZE=$(stat -c%s "$ELF")
          echo "Firmware ELF size: $SIZE bytes"
          # 2 MB = 2097152 bytes. ELF includes debug symbols so the actual
          # flash usage is smaller (stripped .text+.rodata), but a >4 MB ELF
          # indicates something is very wrong with the build.
          MAX_ELF_SIZE=4194304  # 4 MB: conservative upper bound for ELF+debug
          if [ "$SIZE" -gt "$MAX_ELF_SIZE" ]; then
            echo "ERROR: Firmware ELF ($SIZE bytes) exceeds sanity limit ($MAX_ELF_SIZE bytes)"
            echo "Run: cargo size --release --target thumbv7em-none-eabihf -p firmware --features hardware -- -A"
            exit 1
          fi
          echo "OK: firmware ELF size $SIZE bytes is within limits"
