# Hardware CI — SoulAudio DAP (Atopile ERC validation)
#
# Validates the Atopile hardware design on every push/PR to main.
# Runs `ato check` against the check-only build target, which executes all
# `assert` statements (voltage range checks, ERC rules) without requiring
# KiCad to be installed in CI.
#
# All GitHub Actions are pinned to exact commit SHAs for supply-chain security.
# To update a pinned action:
#   1. Find the new release tag at github.com/<owner>/<repo>/releases
#   2. Get the commit SHA: git ls-remote https://github.com/<owner>/<repo> refs/tags/<tag>
#   3. Update the SHA below and the version comment
#
# Current pins (as of 2026-02-19):
#   actions/checkout          v4.2.2   11bd71901bbe5b1630ceea73d27597364c9af683
#   atopile/setup-atopile     v1.8     a44779655197de0f408861581669f09b2145bc33
#   actions/upload-artifact   v4.6.2   ea165f8d65b6e75b540449e92b4886f43607fa02

name: Hardware

on:
  push:
    branches: [main]
    paths:
      - 'hardware/**'
      - '.github/workflows/hardware.yml'
  pull_request:
    branches: [main]
    paths:
      - 'hardware/**'
      - '.github/workflows/hardware.yml'

jobs:
  # ---------------------------------------------------------------------------
  # Hardware Architecture Check
  #
  # Enforces vertical slice boundaries in the Atopile design:
  #   - Module files (mcu, audio, power, display, bluetooth, memory, input)
  #     MUST only import from interfaces.ato or parts/
  #   - main.ato is the only file allowed to import module files
  #
  # If someone accidentally adds a cross-module import (e.g. audio.ato
  # importing from power.ato directly), this check catches it immediately.
  # ---------------------------------------------------------------------------
  hw-arch:
    name: Hardware Architecture
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Verify module import boundaries
        run: |
          # Each module file must only import from interfaces.ato or parts/.
          # main.ato is the top-level wiring file and is exempt.
          VIOLATIONS=$(grep -rn '^from "' \
            hardware/elec/src/mcu.ato \
            hardware/elec/src/audio.ato \
            hardware/elec/src/power.ato \
            hardware/elec/src/display.ato \
            hardware/elec/src/bluetooth.ato \
            hardware/elec/src/memory.ato \
            hardware/elec/src/input.ato \
            hardware/elec/src/clock.ato \
            | grep -v '"interfaces\.ato"' \
            | grep -v '"parts/' \
            || true)
          if [ -n "$VIOLATIONS" ]; then
            echo "Architecture violation: module imports sibling module."
            echo "Module files must only import from interfaces.ato or parts/."
            echo ""
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "OK: all module files only import from interfaces.ato or parts/"

      - name: Verify all module files declare expected ports
        run: |
          # Each module should expose a power_3v3 port (uniform power interface).
          MISSING=""
          for f in \
            hardware/elec/src/mcu.ato \
            hardware/elec/src/audio.ato \
            hardware/elec/src/power.ato \
            hardware/elec/src/display.ato \
            hardware/elec/src/bluetooth.ato \
            hardware/elec/src/memory.ato \
            hardware/elec/src/input.ato; do
            if ! grep -q 'power_3v3' "$f"; then
              MISSING="$MISSING\n  $f (missing power_3v3 port)"
            fi
          done
          if [ -n "$MISSING" ]; then
            echo "Architecture violation: module missing power_3v3 port (uniform power interface):"
            echo -e "$MISSING"
            exit 1
          fi
          echo "OK: all modules declare power_3v3 port"

      - name: Verify interfaces.ato is complete
        run: |
          # Verify that every interface used in module files is declared in interfaces.ato.
          # Extract all `import X` names from module files:
          USED=$(grep -rh '^from "interfaces\.ato" import' \
            hardware/elec/src/mcu.ato \
            hardware/elec/src/audio.ato \
            hardware/elec/src/power.ato \
            hardware/elec/src/display.ato \
            hardware/elec/src/bluetooth.ato \
            hardware/elec/src/memory.ato \
            hardware/elec/src/input.ato \
            hardware/elec/src/clock.ato \
            hardware/elec/src/main.ato \
            | sed 's/.*import //' | tr ',' '\n' | tr -d ' ' | sort -u)
          # Verify each used interface is declared in interfaces.ato
          VIOLATIONS=""
          while IFS= read -r iface; do
            if [ -n "$iface" ] && ! grep -q "^interface $iface:" hardware/elec/src/interfaces.ato; then
              VIOLATIONS="$VIOLATIONS\n  $iface (used but not declared in interfaces.ato)"
            fi
          done <<< "$USED"
          if [ -n "$VIOLATIONS" ]; then
            echo "Architecture violation: interface used but not declared:"
            echo -e "$VIOLATIONS"
            exit 1
          fi
          echo "OK: all used interfaces are declared in interfaces.ato"

      - name: Verify amp_rail port is declared and wired
        run: |
          # power.ato and audio.ato must declare amp_rail (AmpSupplyBus).
          # main.ato must wire them together. mcu.ato must expose amp_en.
          VIOLATIONS=""
          if ! grep -q 'amp_rail' hardware/elec/src/power.ato; then
            VIOLATIONS="$VIOLATIONS\n  power.ato: missing amp_rail port (AmpSupplyBus)"
          fi
          if ! grep -q 'amp_rail' hardware/elec/src/audio.ato; then
            VIOLATIONS="$VIOLATIONS\n  audio.ato: missing amp_rail port (AmpSupplyBus)"
          fi
          if ! grep -q 'power\.amp_rail ~ audio\.amp_rail' hardware/elec/src/main.ato; then
            VIOLATIONS="$VIOLATIONS\n  main.ato: missing 'power.amp_rail ~ audio.amp_rail' wiring"
          fi
          if ! grep -q 'amp_en' hardware/elec/src/mcu.ato; then
            VIOLATIONS="$VIOLATIONS\n  mcu.ato: missing amp_en port (MCU PC4 → TPS61023 EN)"
          fi
          if [ -n "$VIOLATIONS" ]; then
            echo "Architecture violation: ±5V amp rail not properly wired:"
            printf '%b\n' "$VIOLATIONS"
            exit 1
          fi
          echo "OK: amp_rail wired power.ato ↔ audio.ato; amp_en in mcu.ato"

      - name: Verify AmpSupplyBus is imported where used
        run: |
          # Every file that uses AmpSupplyBus must import it from interfaces.ato.
          VIOLATIONS=""
          for f in hardware/elec/src/power.ato hardware/elec/src/audio.ato hardware/elec/src/main.ato; do
            if grep -q 'AmpSupplyBus' "$f" && ! grep -q 'import.*AmpSupplyBus' "$f"; then
              VIOLATIONS="$VIOLATIONS\n  $f: uses AmpSupplyBus but does not import it"
            fi
          done
          if [ -n "$VIOLATIONS" ]; then
            echo "Import violation:"
            printf '%b\n' "$VIOLATIONS"
            exit 1
          fi
          echo "OK: AmpSupplyBus imported in all files that use it"

      - name: Verify all EncoderBus buttons are wired in mcu.ato and input.ato
        run: |
          # All 6 navigation buttons + encoder SW + power must be wired in mcu.ato.
          VIOLATIONS=""
          for btn in btn_play btn_next btn_prev btn_menu btn_back btn_sel btn_power; do
            if ! grep -q "encoder\.$btn" hardware/elec/src/mcu.ato; then
              VIOLATIONS="$VIOLATIONS\n  mcu.ato: missing encoder.$btn wiring"
            fi
          done
          for btn in btn_play btn_next btn_prev btn_menu btn_back btn_sel btn_power; do
            if ! grep -q "encoder\.$btn\b" hardware/elec/src/input.ato; then
              VIOLATIONS="$VIOLATIONS\n  input.ato: missing $btn connection"
            fi
          done
          if [ -n "$VIOLATIONS" ]; then
            echo "Architecture violation: EncoderBus buttons not fully wired:"
            printf '%b\n' "$VIOLATIONS"
            exit 1
          fi
          echo "OK: all 7 EncoderBus buttons wired in mcu.ato and input.ato"

      - name: Verify ClockSource interface wired MCU↔clock module
        run: |
          # mcu.ato must declare hse_clk (ClockSource port) and import ClockSource.
          # main.ato must wire mcu.hse_clk ~ clock.clk.
          # This enforces clock-source modularity: mcu.ato must not contain the crystal.
          VIOLATIONS=""
          if ! grep -q 'hse_clk' hardware/elec/src/mcu.ato; then
            VIOLATIONS="$VIOLATIONS\n  mcu.ato: missing hse_clk port (ClockSource)"
          fi
          if ! grep -q 'ClockSource' hardware/elec/src/mcu.ato; then
            VIOLATIONS="$VIOLATIONS\n  mcu.ato: missing ClockSource import"
          fi
          if ! grep -q 'mcu\.hse_clk ~ clock\.clk' hardware/elec/src/main.ato; then
            VIOLATIONS="$VIOLATIONS\n  main.ato: missing 'mcu.hse_clk ~ clock.clk' wiring"
          fi
          if [ -n "$VIOLATIONS" ]; then
            echo "Architecture violation: ClockSource not properly wired:"
            printf '%b\n' "$VIOLATIONS"
            exit 1
          fi
          echo "OK: ClockSource port wired mcu.ato → main.ato → clock.ato (HseClock)"

      - name: Check for duplicate pin assignments in component stubs
        run: |
          # Each physical pin can only be assigned once in a component stub.
          # Duplicate `~ pin N` entries mean two signals share a pad — a PCB short.
          # This check catches mistakes like assigning both FMC_D6 and ENC_A to PE9.
          VIOLATIONS=""
          for f in hardware/elec/src/parts/*/*.ato; do
            DUPS=$(grep -o '~ pin [0-9]*' "$f" | grep -o '[0-9]*' | sort | uniq -d)
            if [ -n "$DUPS" ]; then
              VIOLATIONS="$VIOLATIONS\n  $f: duplicate pin(s) $DUPS"
            fi
          done
          if [ -n "$VIOLATIONS" ]; then
            echo "ERROR: Duplicate pin assignments found (each duplicate will cause a PCB short):"
            printf '%b\n' "$VIOLATIONS"
            exit 1
          fi
          echo "OK: no duplicate pin assignments in any component stub"

  # ---------------------------------------------------------------------------
  # Atopile ERC check (full system)
  #
  # Validates all `assert` statements in the .ato design files.
  # These act as electrical rule checks (ERC): voltage ranges, impedance
  # matching, and interface compliance are verified at compile time.
  #
  # Does NOT require KiCad — uses the `check-only` build target from ato.yaml
  # which skips the PCB layout step.
  # ---------------------------------------------------------------------------
  ato-check:
    name: Atopile ERC Check (Full System)
    runs-on: ubuntu-latest
    needs: hw-arch   # Architecture boundaries must pass before ERC runs
    timeout-minutes: 10  # ato build can hang; fail fast so logs are available
    defaults:
      run:
        working-directory: hardware

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Set up Atopile
        uses: atopile/setup-atopile@a44779655197de0f408861581669f09b2145bc33  # v1.8
        with:
          version: "0.12.5"

      - name: Install locked dependencies
        run: ato sync

      - name: Run Atopile ERC (ato check)
        run: ato build --build check-only

  # ---------------------------------------------------------------------------
  # Per-module independent validation
  #
  # Each vertical slice module is validated in isolation. This means:
  #   - Imports resolve (all parts/ stubs exist)
  #   - Component-level assert statements pass (R/C/L/crystal values)
  #   - BOM can be generated for the module standalone
  #
  # Fast feedback: if only bluetooth.ato changes, only that job re-runs
  # (GitHub caches are keyed per-job). Modules are independent — a failure
  # in one doesn't block others.
  #
  # Note: cross-module voltage propagation asserts (e.g. power_3v3.voltage)
  # are tested by the full ato-check job above. Per-module jobs validate
  # component selections and module-internal topology.
  # ---------------------------------------------------------------------------
  ato-check-modules:
    name: Module Check (${{ matrix.module }})
    runs-on: ubuntu-latest
    needs: hw-arch
    timeout-minutes: 10  # ato build can hang; fail fast so logs are available
    strategy:
      fail-fast: false  # Run all modules; don't cancel others if one fails
      matrix:
        module: [power, mcu, audio, display, bluetooth, memory, input, clock]
    defaults:
      run:
        working-directory: hardware

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - uses: atopile/setup-atopile@a44779655197de0f408861581669f09b2145bc33  # v1.8
        with:
          version: "0.12.5"

      - name: Install locked dependencies
        run: ato sync

      - name: Validate ${{ matrix.module }} module standalone
        run: ato build --build check-${{ matrix.module }}

  # ---------------------------------------------------------------------------
  # BOM generation
  #
  # Produces the bill of materials from the Atopile netlist and uploads it
  # as a CI artifact. Only runs on pushes to main (not on PRs) to avoid
  # artifact clutter.
  # ---------------------------------------------------------------------------
  bom-generate:
    name: Generate BOM
    runs-on: ubuntu-latest
    needs: [ato-check, ato-check-modules]  # Only generate BOM after all checks pass
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: hardware

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Set up Atopile
        uses: atopile/setup-atopile@a44779655197de0f408861581669f09b2145bc33  # v1.8
        with:
          version: "0.12.5"

      - name: Install locked dependencies
        run: ato sync

      - name: Generate BOM
        run: ato build --build bom-only

      - name: Upload BOM artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: bom-${{ github.sha }}
          path: hardware/build/
          retention-days: 30
          if-no-files-found: warn
