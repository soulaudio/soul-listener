# SoulAudio DAP — Atopile Project Manifest
# https://docs.atopile.io/atopile/reference/config
#
# Stable toolchain pin. The v0.14.x pre-release requires Python 3.14 and has
# breaking changes from the core rewrite (January 2026). Pin to stable v0.12.x
# until v0.14 is declared stable.
requires-atopile: "^0.12.5"

paths:
  src: elec/src
  layout: elec/layouts

builds:
  # ── default ──────────────────────────────────────────────────────────────
  # Full build: BOM + manufacturing data + PCB layout update.
  # Run locally with KiCad installed: `ato build`
  default:
    entry: elec/src/main.ato:SoulAudioDAP
    targets:
      - __default__
    exclude_checks:
      # PCB layout is in progress — DRC will fail until routing is complete.
      # Remove this exclusion once the board is fully routed.
      - PCB.requires_drc_check

  # ── check-only ────────────────────────────────────────────────────────────
  # Schematic + ERC validation only (assert statements), no BOM/PCB output.
  # Used in CI: `ato build --build check-only`.
  #
  # targets: [bom] — REQUIRED for correct stdlib initialization in CI.
  #   - Initializes atopile in BOM mode (no KiCad installation needed).
  #   - Registers Electrical/ElectricPower/Capacitor/Resistor stdlib types.
  # DO NOT use targets: [] — that triggers full KiCad build mode which fails
  # on CI runners without KiCad installed ("Initializing app" fails and stdlib
  # types are never registered → "No class found for Electrical" on every file).
  check-only:
    entry: elec/src/main.ato:SoulAudioDAP
    targets:
      - bom
    exclude_checks:
      - PCB.requires_drc_check

  # ── bom-only ──────────────────────────────────────────────────────────────
  # Generates BOM without touching the PCB file.
  # Useful for sourcing checks in CI (only runs on push to main, not PRs).
  bom-only:
    entry: elec/src/main.ato:SoulAudioDAP
    targets:
      - bom
    exclude_checks:
      - PCB.requires_drc_check

  # ── per-module check targets ───────────────────────────────────────────────
  # Each module can be validated independently. This enables:
  #   1. Faster CI feedback (module that changed is re-checked immediately)
  #   2. Isolation: a broken module doesn't mask failures in others
  #   3. Component-level asserts (resistance, capacitance, frequency) validated
  #      without requiring the full top-level wiring
  #
  # Voltage-level asserts on port signals (e.g. power_3v3.voltage) are
  # additionally verified by the full check-only target which propagates
  # voltages across module boundaries via main.ato.
  #
  # targets: [bom] — see check-only comment above for why this is required.
  # DO NOT use targets: [] — triggers KiCad full-build mode initialization
  # which fails on CI without KiCad installed.
  #
  # Run a single module: ato build --build check-power
  check-power:
    entry: elec/src/power.ato:Power
    targets:
      - bom
    exclude_checks:
      - PCB.requires_drc_check

  check-mcu:
    entry: elec/src/mcu.ato:MCU
    targets:
      - bom
    exclude_checks:
      - PCB.requires_drc_check

  check-audio:
    entry: elec/src/audio.ato:Audio
    targets:
      - bom
    exclude_checks:
      - PCB.requires_drc_check

  check-display:
    entry: elec/src/display.ato:Display
    targets:
      - bom
    exclude_checks:
      - PCB.requires_drc_check

  check-bluetooth:
    entry: elec/src/bluetooth.ato:Bluetooth
    targets:
      - bom
    exclude_checks:
      - PCB.requires_drc_check

  check-memory:
    entry: elec/src/memory.ato:Memory
    targets:
      - bom
    exclude_checks:
      - PCB.requires_drc_check

  check-input:
    entry: elec/src/input.ato:Input
    targets:
      - bom
    exclude_checks:
      - PCB.requires_drc_check

  check-clock:
    entry: elec/src/clock.ato:HseClock
    targets:
      - bom
    exclude_checks:
      - PCB.requires_drc_check
