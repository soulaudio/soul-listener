# SoulAudio DAP — Atopile Project Manifest
# https://docs.atopile.io/atopile/reference/config
#
# Stable toolchain pin. The v0.14.x pre-release requires Python 3.14 and has
# breaking changes from the core rewrite (January 2026). Pin to stable v0.12.x
# until v0.14 is declared stable.
requires-atopile: "^0.12.5"

paths:
  src: elec/src
  layout: elec/layouts

builds:
  # ── default ──────────────────────────────────────────────────────────────
  # Full build: BOM + manufacturing data + PCB layout update.
  # Run locally with KiCad installed: `ato build`
  default:
    entry: elec/src/main.ato:SoulAudioDAP
    targets:
      - __default__
    exclude_checks:
      # PCB layout is in progress — DRC will fail until routing is complete.
      # Remove this exclusion once the board is fully routed.
      - PCB.requires_drc_check

  # ── check-only ────────────────────────────────────────────────────────────
  # Schematic + ERC validation only (assert statements), no output generation.
  # Used in CI: `ato build --build check-only`.
  #
  # targets: [] (empty) — run assert/ERC checks without generating any output
  # files.  Using targets: [bom] causes ato 0.12.5 to hang indefinitely when
  # processing custom atomic parts (is_atomic_part<> trait) during BOM
  # generation; the empty-targets form skips all output and completes quickly.
  check-only:
    entry: elec/src/main.ato:SoulAudioDAP
    targets: []
    exclude_checks:
      - PCB.requires_drc_check

  # ── bom-only ──────────────────────────────────────────────────────────────
  # Generates BOM without touching the PCB file.
  # Useful for sourcing checks in CI (only runs on push to main, not PRs).
  bom-only:
    entry: elec/src/main.ato:SoulAudioDAP
    targets:
      - bom
    exclude_checks:
      - PCB.requires_drc_check

  # ── per-module check targets ───────────────────────────────────────────────
  # Each module can be validated independently. This enables:
  #   1. Faster CI feedback (module that changed is re-checked immediately)
  #   2. Isolation: a broken module doesn't mask failures in others
  #   3. Component-level asserts (resistance, capacitance, frequency) validated
  #      without requiring the full top-level wiring
  #
  # Voltage-level asserts on port signals (e.g. power_3v3.voltage) are
  # additionally verified by the full check-only target which propagates
  # voltages across module boundaries via main.ato.
  #
  # targets: [] (empty) — validate asserts without generating BOM output.
  # See check-only comment above for why targets: [bom] is avoided.
  #
  # Run a single module: ato build --build check-power
  check-power:
    entry: elec/src/power.ato:Power
    targets: []
    exclude_checks:
      - PCB.requires_drc_check

  check-mcu:
    entry: elec/src/mcu.ato:MCU
    targets: []
    exclude_checks:
      - PCB.requires_drc_check

  check-audio:
    entry: elec/src/audio.ato:Audio
    targets: []
    exclude_checks:
      - PCB.requires_drc_check

  check-display:
    entry: elec/src/display.ato:Display
    targets: []
    exclude_checks:
      - PCB.requires_drc_check

  check-bluetooth:
    entry: elec/src/bluetooth.ato:Bluetooth
    targets: []
    exclude_checks:
      - PCB.requires_drc_check

  check-memory:
    entry: elec/src/memory.ato:Memory
    targets: []
    exclude_checks:
      - PCB.requires_drc_check

  check-input:
    entry: elec/src/input.ato:Input
    targets: []
    exclude_checks:
      - PCB.requires_drc_check

  check-clock:
    entry: elec/src/clock.ato:HseClock
    targets: []
    exclude_checks:
      - PCB.requires_drc_check
