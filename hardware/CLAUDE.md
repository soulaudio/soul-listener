# Hardware — Atopile Schematic & PCB

## Overview

This directory contains the hardware design for the SoulAudio DAP board,
written in [Atopile](https://atopile.io) (v0.12.5+). Atopile is a code-first
PCB DSL that compiles `.ato` files into KiCad projects and validates designs
using `assert` statements (acting as ERC rules).

The hardware is organized as **vertical slices** mirroring the firmware crate
structure — each `.ato` module corresponds to a `crates/platform/src/` or
`crates/firmware/src/` module.

## Vertical Slice Mapping

| Hardware module               | Firmware mirror                                                  |
|-------------------------------|------------------------------------------------------------------|
| `elec/src/power.ato`          | `crates/platform/src/power.rs` (PowerManager, PowerMonitor)     |
| `elec/src/audio.ato`          | `crates/platform/src/audio.rs` (AudioCodec)                     |
| `elec/src/display.ato`        | `crates/platform/src/display.rs` + `crates/eink/`               |
| `elec/src/bluetooth.ato`      | `crates/platform/src/bluetooth.rs` + `crates/bluetooth/`        |
| `elec/src/memory.ato`         | `crates/platform/src/sdram.rs` + `asset_store.rs`               |
| `elec/src/input.ato`          | `crates/platform/src/gpio.rs` + `crates/firmware/src/input/`    |
| `elec/src/mcu.ato`            | `crates/firmware/src/` (top-level task orchestration)           |
| `elec/src/main.ato`           | `crates/firmware/src/main.rs` (system wiring / boot sequence)   |

## Directory Structure

```
hardware/
├── ato.yaml                    # Project manifest (entry point, build targets)
├── ato-lock.yaml               # Locked dependency SHAs (commit to VCS)
├── CLAUDE.md                   # This file
├── README.md                   # Human-readable setup + sourcing guide
├── elec/
│   ├── src/
│   │   ├── interfaces.ato      # Shared bus/port interface definitions
│   │   ├── main.ato            # Top-level: SoulAudioDAP module (wires everything)
│   │   ├── mcu.ato             # STM32H743ZIT6 + crystals + decoupling
│   │   ├── audio.ato           # ES9038Q2M DAC + TPA6120A2 amp + LT3042 AVDD
│   │   ├── power.ato           # BQ25895 PMIC + AP2112K-3.3 LDO
│   │   ├── display.ato         # GDEM0397T81P FPC connector + decoupling
│   │   ├── bluetooth.ato       # STM32WB55RGV6 BLE co-processor
│   │   ├── memory.ato          # W9825G6KH-6 SDRAM + W25Q128JVSIQ NOR flash
│   │   ├── input.ato           # EC11 encoder + 5 tactile buttons
│   │   └── parts/              # Atomic component stubs (one subdir per part)
│   │       ├── STM32H743ZIT6/
│   │       ├── ES9038Q2M/
│   │       ├── TPA6120A2/
│   │       ├── LT3042EMSE/
│   │       ├── BQ25895RTWT/
│   │       ├── STM32WB55RGV6/
│   │       ├── W25Q128JVSIQ/
│   │       └── W9825G6KH6/
│   └── layouts/
│       └── default/            # KiCad board layout (generated by `ato build`)
└── bom/
    └── sourcing/
        ├── tme.csv             # TME (Czech/EU) — primary European distributor
        ├── digikey-eu.csv      # Digi-Key EU (Digi-Key Netherlands)
        └── mouser.csv          # Mouser EU (Mouser Electronics)
```

## Atopile Commands

```bash
# Install the Atopile CLI (requires Python 3.11–3.13)
pip install atopile==0.12.5

# Install / update locked dependencies (run after cloning or updating ato-lock.yaml)
cd hardware
ato sync

# Validate design without KiCad (runs assert checks, ERC equivalent)
ato check

# Full build: validate + generate KiCad project (requires KiCad 8 installed)
ato build

# Build a specific named target from ato.yaml
ato build --build check-only    # validation only, no KiCad output
ato build --build bom-only      # generate BOM

# Show all available build targets
ato build --help
```

## Design Rules and `assert` Checks

Atopile's `assert` statements serve as electrical rule checks (ERC). They
validate voltage ranges, resistance values, and interface compliance at
compile time (during `ato check` / `ato build`).

Current assertions:
| Module        | Assertion                                           | Rationale                              |
|---------------|-----------------------------------------------------|----------------------------------------|
| `power.ato`   | `power_3v3.voltage within 3.2V to 3.4V`            | AP2112K-3.3 output tolerance           |
| `power.ato`   | `power_sys.voltage within 3.0V to 4.35V`           | LiPo operating range                   |
| `power.ato`   | `r_ilim.resistance within 90ohm to 110ohm`          | BQ25895 default ~3 A input limit       |
| `power.ato`   | `l_sw.value within 3.5uH to 6uH`                   | BQ25895 boost inductor range           |
| `audio.ato`   | `avdd.voltage within 3.2V to 3.4V`                 | LT3042 output tolerance                |
| `audio.ato`   | `power_3v3.voltage within 3.0V to 3.6V`            | ES9038Q2M DVDD range                   |
| `audio.ato`   | `r_set.resistance within 32kohm to 34kohm`          | LT3042 SET for 3.3 V AVDD              |
| `audio.ato`   | `r_iref.resistance within 1.19kohm to 1.23kohm`     | ES9038Q2M full-scale output current    |
| `display.ato` | `power_3v3.voltage within 2.7V to 3.6V`            | GDEM0397T81P VCI range                 |
| `memory.ato`  | `power_3v3.voltage within 2.7V to 3.6V`            | SDRAM + NOR flash supply range         |
| `memory.ato`  | `r_io0-3.resistance within 30ohm to 36ohm`          | QSPI series termination                |
| `bluetooth.ato` | `power_3v3.voltage within 1.7V to 3.6V`          | STM32WB55 supply range                 |
| `bluetooth.ato` | `hse.frequency within 31MHz to 33MHz`             | 32 MHz BLE RF calibration crystal      |
| `input.ato`   | `r_enc_a/b/sw.resistance within 9k to 11kohm`       | Encoder pull-up values                 |
| `input.ato`   | `c_enc_a/b/sw.capacitance within 80nF to 120nF`     | Debounce cap RC filter verification    |
| `mcu.ato`     | `hse_xtal.frequency within 24MHz to 26MHz`          | STM32H743 PLL input crystal            |
| `main.ato`    | `power.power_3v3.voltage within 3.0V to 3.6V`      | Intersection of all consumer ranges    |

## Architecture Tests (CI)

Two layers of automated checks:

### Hardware (`.github/workflows/hardware.yml`)
| Job | What it checks |
|-----|---------------|
| `hw-arch` | Module import boundaries; all modules declare `power_3v3`; all imported interfaces exist in `interfaces.ato` |
| `ato-check` | Full-system ERC: `assert` voltage propagation across all modules |
| `ato-check-modules` | 7 parallel per-module checks (power/mcu/audio/display/bluetooth/memory/input) |
| `bom-generate` | BOM generation (main branch only, after all checks pass) |

### Rust Firmware (`.github/workflows/ci.yml` → `arch` job)
| Rule | What it enforces |
|------|-----------------|
| Rule 1 | `eink-system` + `eink-components` must not require `eink-emulator` |
| Rule 2 | `eink-specs` must not depend on heavier eink crates or firmware |
| Rule 3 | `platform` (HAL) must not depend on `firmware` (app layer) |
| Rule 4 | `eink-emulator` must not depend on `firmware` |

## Known TODOs

| Item | File | Notes |
|------|------|-------|
| TPA6120A2 ±5 V supply | `audio.ato`, `power.ato` | Needs charge pump (e.g., TPS63700 + ICL7660S) |
| Display FPC pinout | `display.ato` | Request GDEM0397T81P spec from Good Display (buy@e-ink-display.com) |
| QSPI series resistors in signal path | `memory.ato` | Currently declared but not in signal path (TODO comment) |
| ESD TVS array on display SPI lines | `display.ato` | PRTR5V0U2X or similar |
| HSE crystal wiring for STM32H743 | `mcu.ato` | Wire `hse_xtal.p1/p2 ~ mcu.PH0_OSC_IN/PH1_OSC_OUT`; confirm PH0/PH1 pin numbers in KiCad symbol for LQFP-144 |
| PTS526 KiCad footprint | `parts/PTS526/` | No official KiCad footprint exists; add from SnapEDA or create local library entry |
| EC11 pad-to-pin mapping | `parts/EC11/` | Verify integer pin 1–5 maps correctly to KiCad `A/B/C/S1/S2` pads in chosen footprint |

## Sourcing Notes

**Primary EU distributor (Czech Republic):** [TME](https://www.tme.eu/en/)
- Best for standard passives, connectors, ST MCUs, TI ICs
- REST API: https://api.tme.eu — useful for BOM automation and stock checks

**Digi-Key EU (NL warehouse):** [digikey.de](https://www.digikey.de)
- ES9038Q2M (ESS Technology) — often only available here or Mouser in EU

**Mouser EU (DE warehouse):** [mouser.de](https://www.mouser.de)
- LT3042, BQ25895, TPA6120A2 — good stock in EU

**Display (GDEM0397T81P):** Direct from [Good Display](https://www.good-display.com)
- Not available at standard distributors; email: buy@e-ink-display.com

## Component Part Numbers (Key ICs)

| Component          | Part Number        | Package   | Distributor     |
|--------------------|--------------------|-----------|-----------------|
| STM32H743ZIT6      | STM32H743ZIT6      | LQFP-144  | TME / Digi-Key  |
| ES9038Q2M          | ES9038Q2M          | TSSOP-28  | Digi-Key / Mouser |
| TPA6120A2          | TPA6120A2DGN       | MSOP-8 PP | TME / Digi-Key  |
| LT3042EMSE#PBF     | LT3042EMSE#PBF     | MSOP-8E   | Digi-Key / Mouser |
| BQ25895RTWT        | BQ25895RTWT        | WQFN-24   | TME / Digi-Key  |
| STM32WB55RGV6      | STM32WB55RGV6TR    | VFQFPN-68 | TME / Mouser    |
| W25Q128JVSIQ       | W25Q128JVSIQ       | SOIC-8    | TME / Digi-Key  |
| W9825G6KH-6        | W9825G6KH-6        | TSOP-II-54| Digi-Key / Mouser |
| GDEM0397T81P       | GDEM0397T81P       | Module    | Good Display    |
| AP2112K-3.3TRG1    | AP2112K-3.3TRG1    | SOT-25    | TME / Digi-Key  |
| EC11E15244G5       | EC11E15244G5       | THT 5-pin | TME / Digi-Key  |
| PTS526SK15SMTR2LFS | PTS526SK15SMTR2LFS | SMD 6×3.5 mm | TME / Digi-Key |
| 2450AT18A100E      | 2450AT18A100E      | Case 18-4 (1206) | Digi-Key / Newark |
| S2B-PH-K-S         | S2B-PH-K-S         | JST-PH 2mm THT | TME / Digi-Key |

## Adding New Hardware Components

1. Create `elec/src/parts/<PARTNO>/<PARTNO>.ato` with `component` definition
   and `is_atomic_part<>` trait, matching the KiCad symbol pin names exactly.
2. Import the component in the relevant module `.ato` file.
3. Connect power, signals, and decoupling following the existing module pattern.
4. Add an `assert` for any new power rail within its operating range.
5. Add the part to `bom/sourcing/tme.csv` (or relevant distributor file).
6. Update the vertical slice mapping table in this CLAUDE.md.

## CI

The hardware design is validated on every push/PR via
`.github/workflows/hardware.yml` using the official `atopile/setup-atopile`
GitHub Action. The CI runs `ato check` (validation without KiCad) on the
`check-only` build target defined in `ato.yaml`.
